<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>제품 등록 테스트</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; }
        #productList { margin-top: 30px; }
        .product-item { padding: 10px; border: 1px solid #ddd; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>제품 등록 테스트</h1>
    
    <form id="productForm">
        <div class="form-group">
            <label>제품명</label>
            <input type="text" name="name" required>
        </div>
        <div class="form-group">
            <label>카테고리</label>
            <select name="category" required>
                <option value="curtain">커튼</option>
                <option value="blind">블라인드</option>
            </select>
        </div>
        <div class="form-group">
            <label>가격</label>
            <input type="number" name="price" required>
        </div>
        <div class="form-group">
            <label>이미지 (선택)</label>
            <input type="file" name="image" accept="image/*">
        </div>
        <div class="form-group">
            <label>설명</label>
            <textarea name="description" rows="4"></textarea>
        </div>
        <button type="submit">제품 등록</button>
    </form>

    <div id="productList">
        <h2>등록된 제품</h2>
        <div id="products"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCM8IflmHHgMaFseEoPPsECsLxsSAjj1Vw",
            authDomain: "curtainweb.firebaseapp.com",
            projectId: "curtainweb",
            storageBucket: "curtainweb.firebasestorage.app",
            messagingSenderId: "1004027071653",
            appId: "1:1004027071653:web:f29be419700c6302b6114c"
        };
        
        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const IMGBB_API_KEY = 'fec26b54c7d067f90e5896935c9f4205';

        // 제품 목록 로드
        async function loadProducts() {
            console.log('제품 목록 로드 시작...');
            try {
                const snapshot = await db.collection('products').get();
                const productsDiv = document.getElementById('products');
                productsDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    productsDiv.innerHTML = '<p>등록된 제품이 없습니다.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const div = document.createElement('div');
                    div.className = 'product-item';
                    div.innerHTML = `
                        <strong>${product.name}</strong> - ${product.price}원
                        <br>카테고리: ${product.category}
                        ${product.imageUrl ? '<br>이미지: ✓' : ''}
                        <button onclick="deleteProduct('${doc.id}')">삭제</button>
                    `;
                    productsDiv.appendChild(div);
                });
                
                console.log('제품 목록 로드 완료:', snapshot.size + '개');
            } catch (error) {
                console.error('제품 로드 실패:', error);
                alert('제품을 불러오는데 실패했습니다: ' + error.message);
            }
        }

        // 제품 삭제
        async function deleteProduct(id) {
            if (!confirm('삭제하시겠습니까?')) return;
            
            try {
                await db.collection('products').doc(id).delete();
                alert('삭제되었습니다.');
                loadProducts();
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('삭제 실패: ' + error.message);
            }
        }

        // 제품 등록
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('=== 제품 등록 시작 ===');
            
            const formData = new FormData(e.target);
            const imageFile = formData.get('image');
            
            try {
                let imageUrl = '';
                
                // 이미지 업로드
                if (imageFile && imageFile.size > 0) {
                    console.log('이미지 업로드 중...');
                    
                    const imgData = new FormData();
                    imgData.append('image', imageFile);
                    
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: imgData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        imageUrl = result.data.url;
                        console.log('이미지 업로드 성공:', imageUrl);
                    } else {
                        console.error('이미지 업로드 실패:', result);
                    }
                } else {
                    console.log('이미지 없음');
                }
                
                // Firestore에 저장
                const productData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    price: Number(formData.get('price')),
                    description: formData.get('description') || '',
                    imageUrl: imageUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('Firestore 저장 중:', productData);
                
                const docRef = await db.collection('products').add(productData);
                
                console.log('저장 완료! ID:', docRef.id);
                alert('제품이 등록되었습니다!');
                
                e.target.reset();
                loadProducts();
                
            } catch (error) {
                console.error('오류 발생:', error);
                alert('등록 실패: ' + error.message);
            }
        });

        // 페이지 로드 시
        loadProducts();
        console.log('Firebase 연결 상태 - db:', typeof db);
    </script>
</body>
</html>

